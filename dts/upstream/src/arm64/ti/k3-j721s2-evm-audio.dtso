// SPDX-License-Identifier: GPL-2.0-only OR MIT
/*
 * Device Tree Overlay for J721S2 Audio Support
 *
 * Copyright (C) 2026 Texas Instruments Incorporated - https://www.ti.com/
 */

/dts-v1/;
/plugin/;

#include <dt-bindings/gpio/gpio.h>

#include "k3-pinctrl.h"

&{/} {
	codec_audio: sound {
		compatible = "ti,j7200-cpb-audio";
		model = "j721e-cpb";

		ti,cpb-mcasp = <&mcasp4>;
		ti,cpb-codec = <&pcm3168a_1>;

		clocks = <&k3_clks 213 0>, <&k3_clks 213 1>,
			 <&k3_clks 157 299>, <&k3_clks 157 328>;
		clock-names = "cpb-mcasp-auxclk", "cpb-mcasp-auxclk-48000",
			      "cpb-codec-scki", "cpb-codec-scki-48000";
	};

	i2c_mux: mux-controller-2 {
		compatible = "gpio-mux";
		#mux-state-cells = <1>;
		mux-gpios = <&wkup_gpio0 54 GPIO_ACTIVE_HIGH>;
		idle-state = <1>;
		pinctrl-names = "default";
		pinctrl-0 = <&main_i2c3_mux_pins_default>;
	};
};

&main_pmx0 {
	mcasp4_pins_default: mcasp4-default-pins {
		pinctrl-single,pins = <
			J721S2_IOPAD(0x0c8, PIN_OUTPUT_PULLDOWN, 1) /* (AD28) MCASP4_ACLKX */
			J721S2_IOPAD(0x06c, PIN_OUTPUT_PULLDOWN, 1) /* (V26) MCASP4_AFSX */
			J721S2_IOPAD(0x068, PIN_INPUT_PULLDOWN, 1) /* (U28) MCASP4_AXR1 */
			J721S2_IOPAD(0x0c4, PIN_OUTPUT_PULLDOWN, 1) /* (AB26) MCASP4_AXR2 */
			J721S2_IOPAD(0x070, PIN_OUTPUT_PULLDOWN, 1) /* (R27) MCASP4_AXR3 */
		>;
	};

	audio_ext_refclk1_pins_default: audio-ext-refclk1-default-pins {
		pinctrl-single,pins = <
			J721S2_IOPAD(0x078, PIN_OUTPUT, 1) /* (Y25) MCAN2_RX.AUDIO_EXT_REFCLK1 */
		>;
	};
};

&wkup_pmx2 {
	main_i2c3_mux_pins_default: main-i2c3-mux-default-pins {
		pinctrl-single,pins = <
			J721S2_WKUP_IOPAD(0x038, PIN_OUTPUT, 7) /* (B27) WKUP_GPIO0_54 */
		>;
	};
};

&exp2 {
	p09-hog {
		/* P09 - MCASP/TRACE_MUX_S0 */
		gpio-hog;
		gpios = <9 GPIO_ACTIVE_HIGH>;
		output-low;
		line-name = "MCASP/TRACE_MUX_S0";
	};

	p10-hog {
		/* P10 - MCASP/TRACE_MUX_S1 */
		gpio-hog;
		gpios = <10 GPIO_ACTIVE_HIGH>;
		output-high;
		line-name = "MCASP/TRACE_MUX_S1";
	};
};

&mux0 {
	idle-state = <0>;
};

&mux1 {
	idle-state = <0>;
};

&scm_conf {
	#address-cells = <1>;
	#size-cells = <1>;

	audio_refclk1: clock-controller@42e4 {
		compatible = "ti,am62-audio-refclk";
		reg = <0x42e4 0x4>;
		clocks = <&k3_clks 157 299>;
		assigned-clocks = <&k3_clks 157 299>;
		assigned-clock-parents = <&k3_clks 157 328>;
		#clock-cells = <0>;
	};
};

&k3_clks {
	/* Configure AUDIO_EXT_REFCLK1 pin as output */
	pinctrl-names = "default";
	pinctrl-0 = <&audio_ext_refclk1_pins_default>;
};

&main_i2c3 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&main_i2c3_pins_default>;
	clock-frequency = <400000>;
	mux-states = <&i2c_mux 1>;
	#address-cells = <1>;
	#size-cells = <0>;

	exp3: gpio@20 {
		compatible = "ti,tca6408";
		reg = <0x20>;
		gpio-controller;
		#gpio-cells = <2>;
		gpio-line-names = "CODEC_RSTZ", "CODEC_SPARE1",
				  "UB926_RESETN", "UB926_LOCK",
				  "UBS926_PWR_SW_CNTRL", "UB926_TUNER_RESET",
				  "UB926_GPIO_SPARE";
	};

	pcm3168a_1: audio-codec@44 {
		compatible = "ti,pcm3168a";
		reg = <0x44>;
		#sound-dai-cells = <1>;
		reset-gpios = <&exp3 0 GPIO_ACTIVE_LOW>;
		clocks = <&audio_refclk1>;
		clock-names = "scki";
		VDD1-supply = <&vsys_3v3>;
		VDD2-supply = <&vsys_3v3>;
		VCCAD1-supply = <&vsys_5v0>;
		VCCAD2-supply = <&vsys_5v0>;
		VCCDA1-supply = <&vsys_5v0>;
		VCCDA2-supply = <&vsys_5v0>;
	};
};

&mcasp4 {
	status = "okay";
	#sound-dai-cells = <0>;
	pinctrl-names = "default";
	pinctrl-0 = <&mcasp4_pins_default>;
	op-mode = <0>;          /* MCASP_IIS_MODE */
	tdm-slots = <2>;
	auxclk-fs-ratio = <256>;
	serial-dir = <	/* 0: INACTIVE, 1: TX, 2: RX */
		0 2 1 1
		0 0 0 0
		0 0 0 0
		0 0 0 0
	>;
};
